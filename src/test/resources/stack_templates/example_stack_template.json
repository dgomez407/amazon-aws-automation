{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"Template of LBS Autoscaling solution (created from AWS CloudFormation Sample Template AutoScalingKeepAtNSample)",
    "Parameters":{
        "InstanceType":{
            "Description":"WebServer EC2 instance type",
            "Type":"String",
            "Default":"c1.medium",
            "AllowedValues":[
                "t1.micro",
                "m1.small",
                "m1.medium",
                "m1.large",
                "m1.xlarge",
                "m2.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "c1.medium",
                "c1.xlarge",
                "cc1.4xlarge",
                "cc2.8xlarge",
                "cg1.4xlarge"
            ],
            "ConstraintDescription":"must be a valid EC2 instance type."
        },
        "KeyName":{
            "Description":"Name of an existing EC2 KeyPair to enable SSH access to the instances",
            "Type":"String",
            "Default":"warta_test_env"
        },
        "AMIId":{
            "Description":"Id of AMI to launch",
            "Type":"String"
        },
        "UserData":{
            "Description":"Data passed to starting instances",
            "Type":"String"
        },
        "InstanceSecurityGroup":{
            "Description":"Security group to be assigned to instances",
            "Type":"String",
            "Default":"mascoma"
        },
        "MinInstances":{
            "Description":"Minimum size of auto scaling group",
            "Type":"Number",
            "Default":"2"
        },
        "MaxInstances":{
            "Description":"Maximum size of auto scaling group",
            "Type":"Number",
            "Default":"6"
        },
        "GracePeriod":{
            "Description":"Auto scaling group grace period (in seconds)",
            "Type":"Number",
            "Default":"360"
        },
        "ScalingUpAdjustment":{
            "Description":"Scaling up group size percentage adjustment",
            "Type":"Number",
            "Default":"200"
        },
        "ScalingDownAdjustment":{
            "Description":"Scaling down group size percentage adjustment",
            "Type":"Number",
            "Default":"30"
        },
        "ScaleUpCooldown":{
            "Description":"A period of time from triggering an auto scaling scale up activity during which no other auto scaling activity can take place (in seconds)",
            "Type":"Number",
            "Default":"420"
        },
        "ScaleDownCooldown":{
            "Description":"A period of time from triggering an auto scaling scale down activity during which no other auto scaling activity can take place (in seconds)",
            "Type":"Number",
            "Default":"120"
        },
        "HealthCheck":{
            "Description":"Description of url which should be accessed to confirm that instance is working. For traffic tiles select HTTP:8080/healthcheck for reverse geocoding HTTP:8080/lbs-rev-geo/services/reverseGeocode/3/json?point=51.45,0 for traffic model HTTP:8080/lbs-traffic/services/trafficIcons/3/s1/6252585.5986398,265030.61127176,6261721.3571218,293518.18861528/12/-1/xml for viewport description HTTP:8080/lbs-viewport-description/services/viewportDesc/3/-997961.84129103,-32306568.626899,14617205.793031,39820634.255445/2/-997961.84129103,-32306568.626899,14617205.793031,39820634.255445/0/false/xml for initialize HTTP:8080/lbs-initialize/services/initialize/3/json for hdt regions HTTP:8080/lbs-hdt-regions/services/hdtRegions/3/json?language=fr&projection=EPSG4326",
            "Type":"String"
        },
        "AZList":{
            "Description":"List of Availability zones to deploy to",
            "Type":"CommaDelimitedList",
            "Default":"us-east-1b"
        },
	    "SNSTopicAlarm":{
	        "Type":"String",
	        "Description":"ARN adress of topic for alarms"
	    },
	    "InstancesCountAlarmTreshold":{
            "Type":"Number",
	        "Description":"Number of instances which should be close to the maximum. When typed number of machines is instantiated the alarm is raised.",
            "Default":"4"
        }
    },
    "Resources":{
        "ElasticLoadBalancer":{
            "Type":"AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties":{
                "AvailabilityZones":{
                    "Ref":"AZList"
                },
                "Listeners":[
                    {
                        "LoadBalancerPort":"80",
                        "InstancePort":"8080",
                        "Protocol":"HTTP"
                    }
                ],
                "HealthCheck":{
                    "Target":{
                        "Ref":"HealthCheck"
                    },
                    "HealthyThreshold":"2",
                    "UnhealthyThreshold":"2",
                    "Interval":"21",
                    "Timeout":"20"
                }
            }
        },
        "WebServerGroup":{
            "Type":"AWS::AutoScaling::AutoScalingGroup",
            "Properties":{
                "AvailabilityZones":{
                    "Ref":"AZList"
                },
                "LaunchConfigurationName":{
                    "Ref":"LaunchConfig"
                },
                "MinSize":{
                    "Ref":"MinInstances"
                },
                "MaxSize":{
                    "Ref":"MaxInstances"
                },
                "LoadBalancerNames":[
                    {
                        "Ref":"ElasticLoadBalancer"
                    }
                ],
                "HealthCheckGracePeriod":{
                    "Ref":"GracePeriod"
                },
                "HealthCheckType":"ELB"
            }
        },
        "LaunchConfig":{
            "Type":"AWS::AutoScaling::LaunchConfiguration",
            "Properties":{
                "KeyName":{
                    "Ref":"KeyName"
                },
                "ImageId":{
                    "Ref":"AMIId"
                },
                "UserData":{
                    "Fn::Base64":{
                        "Ref":"UserData"
                    }
                },
                "SecurityGroups":[
                    {
                        "Ref":"InstanceSecurityGroup"
                    }
                ],
                "InstanceType":{
                    "Ref":"InstanceType"
                }
            }
        },
        "WebServerScaleUpPolicy":{
            "Type":"AWS::AutoScaling::ScalingPolicy",
            "Properties":{
                "AdjustmentType":"PercentChangeInCapacity",
                "AutoScalingGroupName":{
                    "Ref":"WebServerGroup"
                },
                "Cooldown":{
                    "Ref":"ScaleUpCooldown"
                },
                "ScalingAdjustment":{
                    "Ref":"ScalingUpAdjustment"
                }
            }
        },
        "WebServerScaleDownPolicy":{
            "Type":"AWS::AutoScaling::ScalingPolicy",
            "Properties":{
                "AdjustmentType":"PercentChangeInCapacity",
                "AutoScalingGroupName":{
                    "Ref":"WebServerGroup"
                },
                "Cooldown":{
                    "Ref":"ScaleDownCooldown"
                },
                "ScalingAdjustment":{
                    "Fn::Join":[
                        "",
                        [
                            "-",
                            {
                                "Ref":"ScalingDownAdjustment"
                            }
                        ]
                    ]
                }
            }
        },
        "CPUAlarmHigh":{
            "Type":"AWS::CloudWatch::Alarm",
            "Properties":{
                "AlarmDescription":"Scale-up if CPU > 65% for 1 minute",
                "MetricName":"CPUUtilization",
                "Namespace":"AWS/EC2",
                "Statistic":"Average",
                "Period":"60",
                "EvaluationPeriods":"1",
                "Threshold":"65",
                "AlarmActions":[
                    {
                        "Ref":"WebServerScaleUpPolicy"
                    }
                ],
                "Dimensions":[
                    {
                        "Name":"AutoScalingGroupName",
                        "Value":{
                            "Ref":"WebServerGroup"
                        }
                    }
                ],
                "ComparisonOperator":"GreaterThanThreshold"
            }
        },
        "CPUAlarmLow":{
            "Type":"AWS::CloudWatch::Alarm",
            "Properties":{
                "AlarmDescription":"Scale-down if CPU < 40% for 5 minutes",
                "MetricName":"CPUUtilization",
                "Namespace":"AWS/EC2",
                "Statistic":"Average",
                "Period":"60",
                "EvaluationPeriods":"5",
                "Threshold":"40",
                "AlarmActions":[
                    {
                        "Ref":"WebServerScaleDownPolicy"
                    }
                ],
                "Dimensions":[
                    {
                        "Name":"AutoScalingGroupName",
                        "Value":{
                            "Ref":"WebServerGroup"
                        }
                    }
                ],
                "ComparisonOperator":"LessThanThreshold"
            }
        },
        "NoHostAlarm":{
            "Type":"AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription":"There are no instances currently available in ELB",
	            "MetricName":"HealthyHostCount",
                "Namespace":"AWS/ELB",
                "Statistic":"Maximum",
                "Period":"60",
                "EvaluationPeriods":"2",
                "Threshold":{
                    "Ref":"MinInstances"
                },
                "ComparisonOperator":"LessThanThreshold",
                "AlarmActions":[
                    {
                        "Ref":"SNSTopicAlarm"
                    }
                ],
                "Dimensions":[
                    {
                        "Name":"LoadBalancerName",
                        "Value":{
                            "Ref":"ElasticLoadBalancer"
                        }
                    }
                ]
            }
        },
        "TresholdCountHostAlarm":{
            "Type":"AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription":"Number of instances in ELB has reached an alarm treshold level.",
                "MetricName":"HealthyHostCount",
                "Namespace":"AWS/ELB",
                "Statistic":"Maximum",
                "Period":"60",
                "EvaluationPeriods":"2",
                "Threshold":{
                    "Ref":"InstancesCountAlarmTreshold"
                },
                "ComparisonOperator":"GreaterThanOrEqualToThreshold",
                "AlarmActions":[
                    {
                        "Ref":"SNSTopicAlarm"
                    }
                ],
                "Dimensions":[
                    {
                        "Name":"LoadBalancerName",
                        "Value":{
                            "Ref":"ElasticLoadBalancer"
                        }
                    }
                ]
            }
        }
    },
    "Outputs":{
        "URL":{
            "Description":"URL of the loadbalancer",
            "Value":{
                "Fn::Join":[
                    "",
                    [
                        "http://",
                        {
                            "Fn::GetAtt":[
                                "ElasticLoadBalancer",
                                "DNSName"
                            ]
                        }
                    ]
                ]
            }
        }
    }
}
